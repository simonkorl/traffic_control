# traffic control 脚本

使用 `tc` 命令来控制网卡的数据发送。使用 python 或是 sh 脚本来控制带宽、时延、丢包等信息。

关于 TC 命令的知识可以参考 https://tldp.org/HOWTO/Traffic-Control-HOWTO/ 进行学习。也可以参考 `man tc`, `man tc-netem`, `man tc-tbf` 与 `man tc-htb` 来学习命令的使用方法。

## python 脚本

### 文件格式

| 起始时刻 (s) | 带宽 (B/s)    | 丢包率 (0,1) | 延迟 (s)    |
|--|--|--|--|
  |            0 | 5.25 (42Mbps) | 0.01 (1%)    | 0.4 (400ms) |

文件样例：

```txt
0,8.321078049659501,0.01,0.001
1,8.321078049659501,0.01,0.001
2,2.427785031152542,0.01,0.001
3,2.427785031152542,0.01,0.001
4,2.427785031152542,0.01,0.001
5,2.427785031152542,0.01,0.001
6,4.0255725874874715,0.01,0.001
7,6.823990925231896,0.01,0.001
8,2.401292668088253,0.01,0.001
9,2.401292668088253,0.01,0.001
10,2.401292668088253,0.01,0.001
11,2.401292668088253,0.01,0.001
12,2.820602388227434,0.01,0.001
13,2.820602388227434,0.01,0.001
14,2.820602388227434,0.01,0.001
15,2.820602388227434,0.01,0.001
16,6.875152530514945,0.01,0.001
17,6.875152530514945,0.01,0.001
18,6.875152530514945,0.01,0.001
19,6.875152530514945,0.01,0.001
20,6.300111263996314,0.01,0.001
21,6.300111263996314,0.01,0.001
22,6.300111263996314,0.01,0.001
23,4.944413121705228,0.01,0.001
24,4.944413121705228,0.01,0.001
25,4.944413121705228,0.01,0.001
26,4.944413121705228,0.01,0.001
27,9.260474313462687,0.01,0.001
28,9.260474313462687,0.01,0.001
29,9.260474313462687,0.01,0.001
30,9.260474313462687,0.01,0.001
31,6.890335672284591,0.01,0.001
32,6.890335672284591,0.01,0.001
33,6.890335672284591,0.01,0.001
34,6.890335672284591,0.01,0.001
35,11.441786015487626,0.01,0.001
36,11.441786015487626,0.01,0.001
37,11.441786015487626,0.01,0.001
38,11.441786015487626,0.01,0.001
39,5.227927830144467,0.01,0.001
40,5.227927830144467,0.01,0.001
41,5.227927830144467,0.01,0.001
42,1.674401227280534,0.01,0.001
43,1.674401227280534,0.01,0.001
44,1.674401227280534,0.01,0.001
45,1.674401227280534,0.01,0.001
46,6.773547251065549,0.01,0.001
47,6.773547251065549,0.01,0.001
48,6.773547251065549,0.01,0.001
49,6.773547251065549,0.01,0.001
```


### 部分选项解释

- `-load`：读取某个文件并且使用里面的设定控制网速
- `-once`: 如果不打算读取文件进行配置，那么就是用这个选项
- `-nic`: 后面输入接口的名称
- `-loss`: 丢包率的百分数
- `--delay`, `-dl`：可以改变时延，单位是秒
- `-bw`, `--bandwith`：可以改变带宽，单位是 Mbps
- `-r`, `--reset`：取消对某个接口的限速
- `-aft`：在若干秒之后执行命令

详细的选项请见文件内 argparse 的配置。

注：python 脚本在不同的环境下可能表现不同，可能是因为命令行传参的区别。请尤其注意 `-nic` 选项。

## shell 脚本

可以使用 `sudo sh xxx.sh xxx` 的格式运行 sh 目录下的脚本。这些脚本基于 TC 命令书写，可以通过命令的组合书写其他功能的脚本。

- `tc-netem`: 使用 netem 进行网络模拟。可以调节时延（DELAY）、丢包（LOSS）、带宽（BW）以及 buffer 大小（LIMIT）
  - 格式：`sudo sh tc-netem.sh DEV DELAY LOSS RATE LIMIT`

    样例：`sudo sh tc-netem.sh lo 100ms 'random 1' 10mbit 10000`

  - DELAY: TIME [ JITTER [ CORRELATION ]]]
              [ distribution { uniform | normal | pareto |  paretonormal } ]
  - LOSS: { random PERCENT [ CORRELATION ]  |
                      state p13 [ p31 [ p32 [ p23 [ p14]]]] |
                      gemodel p [ r [ 1-h [ 1-k ]]] }  [ ecn ]
  - RATE: RATE [ PACKETOVERHEAD [ CELLSIZE [ CELLOVERHEAD ]]]]
  - LIMIT: packets
- `tc-delay`: 使用 netem 的简单版本，只能调整 delay 。
  - 格式：`sudo sh tc-delay.sh DEV DELAY`

    样例：`sudo sh tc-delay.sh lo 100ms`

- `tc-tbf`: 使用 tbf 限制发送速率的脚本
  - 格式：`sudo sh tc-tbf.sh DEV BW BURST LATENCY`

    样例：`sudo sh tc-tbf.sh lo 1mbit 5kb 70ms`
  - BURST: 代表缓存 buffer 的大小
  - LATENCY: 代表数据进入 filter 之前最大的等待时间

- `tc-bw-delay`: 结合 netem 与 tbf 进行带宽与时延的控制
  
  - 格式：`sudo sh tc-tbf.sh DEV DELAY BW BURST LATENCY`

    样例：`sudo sh tc-tbf.sh lo 50ms 1mbit 5kb 70ms`

- `tc-add`: 结合 netem 与 tbf 进行较为全面的网络模拟和带宽控制

  - 格式：`sudo sh tc-add.sh DEV DELAY LOSS BW BURST LATENCY`

    样例：`sudo sh tc-add.sh lo 50ms 'random 1' 1mbit 5kb 70ms`

- `tc-htb`：模仿 python 脚本进行的 htb 限速示意脚本

  - 格式：`sudo sh tc-add.sh DEV BW`

    样例：`sudo sh tc-add.sh lo 1mbit`

- `tc-del`：删除接口上的控制

  - 格式：`sudo sh tc-del.sh DEV`

    样例：`sudo sh tc-del.sh lo`
